{% extends 'base.html' %}
{% load main_tags %}

{% block content %}
    <main class="main">
        <div class="container">
            <div class="advertisement-book">
                <div class="advertisement-book__info">
                    <div class="advertisement-book__info-title">
                        {{ offer.book.title }}
                    </div>
                    <div class="advertisement-book__info-author">
                        {{ offer.book.author }}
                    </div>
                    {% if request.user.is_authenticated %}
                        {% check_favorite user=request.user offer=offer as favorite %}
                    {% endif %}
                    <button class="advertisement-book__favorite-button {% if request.user.is_authenticated and favorite %}active{% endif %}" onclick="toggleFavorite(this)" data-offer-id="{{ offer.id }}" >
                        Добавить в избранное
                        <i class="far fa-star star-icon {% if request.user.is_authenticated and favorite %}fas{% else %}far{% endif %}"></i>
                    </button>
                    <div class="advertisement-book_description">
                        <p class="book_desc">{{ offer.book.description }}</p>
                    </div>
                </div>
                <div class="advertisement-book__img-container">
                    <img class="advertisement-book__img" src="{% if offer.photos.all.first %}{{ offer.photos.all.first.image.url }}{% else %}{{ offer.book.img.url }}{% endif %}" alt="Фото книги">
                </div>
            </div>
            <div class="advertisement-description">
                <p class="advertisement-desc">
                    {{ offer.description }}
                </p>
            </div>
            <div class="advertisement-info">
                <div class="advertisement-info__column-small">
                    <div class="advertisement-info__block-sm">
                        <div class="advertisement-info__title">
                            Язык
                        </div>
                        <div class="advertisement-info__options">
                            {{ offer.book.language }}
                        </div>
                    </div>
                    <div class="advertisement-info__block-sm">
                        <div class="advertisement-info__title">
                            Категории
                        </div>
                        <div class="advertisement-info__options">
                            {{ offer.book.category.all|join:", " }}
                        </div>
                    </div>
                    <div class="advertisement-info__block-sm">
                        <div class="advertisement-info__title">
                            Местоположение
                        </div>
                        <div class="advertisement-info__options">
                            {% if offer.address %}{{ offer.address }}{% else %}Адресс не указан{% endif %}
                        </div>
                    </div>
                </div>
                <div class="advertisement-info__column-large">
                    <div class="advertisement-info__block-l">
                        <div class="advertisement-info__title">
                            Дата публикации
                        </div>
                        <div class="advertisement-info__options">
                            {{ offer.book.release_year }}
                        </div>
                    </div>
                    <div class="advertisement-info__block-l">
                        <div class="advertisement-info__title">
                            Издательство
                        </div>
                        <div class="advertisement-info__options">
                            {{ offer.book.publisher }}
                        </div>
                    </div>
                    <div class="advertisement-info__block-l">
                        <div class="advertisement-info__title">
                            Дата создания объявления
                        </div>
                        <div class="advertisement-info__options">
                            {{ offer.date_created|date }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="advertisement-profile">
                <div class="advertisement-profile__desc">
                    <a href="{% url 'profile:profile' offer.user.pk %}" class="advertisement-profile__desc-link">
                        <img src="{{ offer.user.photo.url }}" alt="Фото профиля" class="advertisement-profile__desc-img">
                        <div class="advertisement-profile__info">
                            <div class="advertisement-profile__info-name">
                                 {% if offer.user.first_name and offer.user.last_name %}{{ offer.user.first_name }} {{ offer.user.last_name }}{% else %}{{ offer.user.username }}{% endif %}
                            </div>
                            <div class="advertisement-profile__info-score">
                                <div class="score-number">4.5</div>
                                <i class="fas fa-star score-star"></i>
                            </div>
                            <div class="advertisement-profile__info-date">
                                Создан <span>{{ offer.user.date_joined|date }}</span>
                            </div>
                        </div>
                    </a>
                </div>
                <button class="advertisement-profile__button">
                    Написать сообщение
                </button>
            </div>
        </div>
    </main>
{% endblock %}

{% block extra_js %}
    <script>
        function toggleFavorite(element) {
            const offerId = element.getAttribute('data-offer-id');
            const heartIcon = element.querySelector('.fa-star');
            const csrfToken = "{{ csrf_token }}";  // CSRF-токен из шаблона

            fetch("{% url 'book:toggle-favorite' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: 'offer_id=' + offerId
            })
            .then(response => response.json())  // Всегда ждём JSON
            .then(data => {
                if (data.status === 'success') {
                    // Успешное добавление/удаление избранного
                    element.classList.toggle('active', data.is_favorite);
                    heartIcon.classList.toggle('far', !data.is_favorite);  // Пустое сердце
                    heartIcon.classList.toggle('fas', data.is_favorite);   // Заполненное сердце
                } else if (data.status === 'error' && data.message === 'Требуется вход в систему') {
                    // Перенаправление на страницу входа
                    window.location.href = "{% url 'login' %}?next=" + encodeURIComponent(window.location.pathname);
                } else {
                    // Другие ошибки (например, "Книга не найдена")
                    alert(data.message || 'Произошла ошибка');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Не удалось выполнить запрос');
            });
        }
    </script>
{% endblock %}
