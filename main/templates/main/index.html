{% extends 'base.html' %}
{% load static %}
{% load cache %}
{% load main_tags %}

{% block content %}
    <main class="main">
        <div class="container">
            <div class="searching-section section">
                <div class="searching-section_bar">
                    <img src="{% static 'main/img/magnifier.svg' %}" alt="Изображение лупы" class="magnifier-img">
                    <textarea class="searching-section_bar-text" placeholder="Введите название или автора"></textarea>
                    <button class="button-searching-section">Поиск</button>
                </div>
                <div class="searching-section_name">
                    <h2 class="searching-section_title">Обменивайтесь книгами</h2>
                    <h3 class="searching-section_subtitle">
                        Найдите нужную книгу и обменяйте её на свою с другими любителями литературы
                    </h3>
                </div>
            </div>    
        
            <div class="image-section">
                <div class="popular-books">
                    <div class="popular-books__title image-section__book-title">
                        Популярная книга сегодня
                    </div>
                    <div class="image-section__book-card">
                        <div class="image-section__book-card_favorite" onclick="toggleFavorite(this)">
                            <i class="far fa-heart"></i> 
                        </div>
                        <a href="#" class="image-section__book-card_link">
                            <img src="{% static 'main/img/popular-book.png' %}" alt="Фото книги" class="image-section__book-card_img">
                            <div class="image-section__book-card_info">
                                <div class="image-section__book-card_author">А. С. Пушкин</div>
                                <div class="image-section__book-card_name">Капитанская дочка</div>
                                <div class="image-section__book-card_location">Архангельск, пр-кт Новгородский, 34к2</div>
                                <div class="image-section__book-card_date">Сегодня в 18:00</div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="new-books">
                    <div class="popular-books__title image-section__book-title">
                        Новая книга на сайте
                    </div>
                    <div class="image-section__book-card">
                        <div class="image-section__book-card_favorite" onclick="toggleFavorite(this)">
                            <i class="far fa-heart"></i> 
                        </div>
                        <a href="#" class="image-section__book-card_link">
                            <img src="{% static 'main/img/new-book.png' %}" alt="Фото книги" class="image-section__book-card_img">
                            <div class="image-section__book-card_info">
                                <div class="image-section__book-card_author">А. С. Пушкин</div>
                                <div class="image-section__book-card_name">Капитанская дочка</div>
                                <div class="image-section__book-card_location">Архангельск, пр-кт Новгородский, 34к2</div>
                                <div class="image-section__book-card_date">Сегодня в 18:00</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            {% with request.user.is_authenticated as auth %}
                {% if not auth %}
                    <div class="welcome-section section">
                        <div class="welcome-section__title">
                            Добро пожаловать в КнигАрх
                        </div>
                        <div class="welcome-section__subtitle">
                            КнигАрх - биржа для обмена книгами в городе Архангельск. Вы можете найти книги, которые хотите прочитать или поделиться ими с другими. Начните свое книжное путешествие прямо сейчас!
                        </div>
                        <a class="welcome-section__button" href="{% url 'profile:registration' %}">
                            Зарегистрируйся бесплатно
                        </a>
                    </div>
                {% endif %}

                {% cache 300 category %}
                    <div class="catigories-section">
                        <div class="catigories-section__title section__title">
                            Категории
                        </div>
                        <div class="catigories-section__cards">
                            {% for cat in cats %}
                                <div class="catigories-section__card">
                                    <img src="{{ cat.img.url }}" alt="{{ cat.name }}" class="catigories-section__card-img">
                                    <div class="catigories-section__card-title">{{ cat.name }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endcache %}

                {% cache 120 all-books_section %}
                    <div class="all-books-section">
                        <div class="all-books-section__title section__title">
                            <span class="all-books-section__text">Все объявления</span>
                            <span class="all-books-section__arrow">→</span>
                        </div>
                        <div class="all-books-section__cards">
                            {% for offer in all_books %}
                                <div class="all-books-section__card book-card">
                                    {% if auth %}
                                        {% check_favorite user=request.user offer=offer as favorite %}
                                    {% endif %}
                                    <div class="book-card_favorite {% if auth and favorite %}active{% endif %}" onclick="toggleFavorite(this)" data-offer-id="{{ offer.id }}">
                                        <i class="far fa-heart"></i>
                                    </div>
                                    <a href="{% url 'book:book-offer' offer.uuid_post %}" class="book-card_link">
                                        <img src="{% if offer.photos.all.first %}{{ offer.photos.all.first.image.url }}{% else %}{{ offer.book.img.url }}{% endif %}" alt="Фото книги" class="book-card_img">
                                        <div class="book-card_info">
                                            <div class="book-card_author">{{ offer.book.author }}</div>
                                            <div class="book-card_name">{{ offer.book.title}}</div>
                                            <div class="book-card_location">{% if offer.address %}{{ offer.address }}{% else %}Адресс не указан{% endif %}</div>
                                            <div class="book-card_date">{{ offer.date_created }}</div>
                                        </div>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endcache %}
            {% endwith %}
        </div>
        <hr>
    </main>
{% endblock %}

{% block extra_js %}
    <script>
        function toggleFavorite(element) {
            const offerId = element.getAttribute('data-offer-id');
            const heartIcon = element.querySelector('.fa-heart');
            const csrfToken = "{{ csrf_token }}";  // CSRF-токен из шаблона

            fetch("{% url 'profile:toggle-favorite' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: 'offer_id=' + offerId
            })
            .then(response => response.json())  // Всегда ждём JSON
            .then(data => {
                if (data.status === 'success') {
                    // Успешное добавление/удаление избранного
                    element.classList.toggle('active', data.is_favorite);
                    heartIcon.classList.toggle('far', !data.is_favorite);  // Пустое сердце
                    heartIcon.classList.toggle('fas', data.is_favorite);   // Заполненное сердце
                } else if (data.status === 'error' && data.message === 'Требуется вход в систему') {
                    // Перенаправление на страницу входа
                    window.location.href = "{% url 'profile:login' %}?next=" + encodeURIComponent(window.location.pathname);
                } else {
                    // Другие ошибки (например, "Книга не найдена")
                    alert(data.message || 'Произошла ошибка');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Не удалось выполнить запрос');
            });
        }
    </script>
{% endblock %}
